import { useContext, useState, useEffect, createContext, useCallback } from "react"
import axios from "axios"
import { useRouter } from "next/router"

const AuthContext = createContext()

export function useAuth() {
	return useContext(AuthContext)
}

const uprotectedRoutes = ['/login', '/signup', '/forgotpassword', '/', '/[profile]', '/p/[post]']

export function AuthProvider({ children }) {
	const [currentUser, setCurrentUser] = useState()
	const [refreshPosts, setRefreshPosts] = useState()
	const [loading, setLoading] = useState(true)
	const router = useRouter()


	function logout() {
    router.replace("/login")
    axios.get("http://localhost:5000/api/auth/logout", { headers: { Authorization: `Bearer ${currentUser.token}`}, withCredentials: true, credentials: 'include'})
	}
  const verifyUser = () => {
    axios.put("http://localhost:5000/api/auth/refreshtoken", {}, {withCredentials: true, credentials: 'include'}).then(async (res)=>{
      setCurrentUser(res.data)
      if(!uprotectedRoutes.includes(router.pathname)){
        if(res.data.token){
          setLoading(false)
        }else{
          setLoading(true)
          await router.replace({
            pathname: '/login',
            query: { returnUrl: router.pathname }
          }).then(()=>{setLoading(false)})
        }
      }else{
        setLoading(false)
      }
    }).catch(async (error)=>{
      if(!uprotectedRoutes.includes(router.pathname)){
        setLoading(true)
        await router.replace({
          pathname: '/login',
          query: { returnUrl: router.pathname }
        }).then(()=>{setLoading(false)})
      }else{
        setLoading(false)
      }
    })
  }


  useEffect(() => {
    verifyUser()
  }, [])


	const value = {
		currentUser,
    refreshPosts,
    setRefreshPosts,
    setCurrentUser,
		logout,
	}
	
	return (
		<AuthContext.Provider value={value}>
		{loading ? 
      <div className="flex h-screen w-screen items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" width="240" height="45" viewBox="0 0 240 45"><defs><clipPath id="clip-campus-online-logo"><rect width="240" height="45"/></clipPath></defs><g id="campus-online-logo" clipPath="url(#clip-campus-online-logo)"><path id="Exclusion_1" data-name="Exclusion 1" d="M103,44H-3a7.008,7.008,0,0,1-7-7V6A7.008,7.008,0,0,1-3-1H103a7.008,7.008,0,0,1,7,7V37A7.008,7.008,0,0,1,103,44ZM99.311,27.83a.617.617,0,0,0-.516.3,3.642,3.642,0,0,1-1.454,1.555c-.33.214-.5.412-.5.589a.408.408,0,0,0,.076.286,3.323,3.323,0,0,0,.344.268,3.025,3.025,0,0,1,.851.592,5.124,5.124,0,0,1,.6.918.742.742,0,0,0,.592.4c.189,0,.374-.148.551-.44a3.6,3.6,0,0,1,1.5-1.472.556.556,0,0,0,.323-.478.541.541,0,0,0-.067-.3,1.129,1.129,0,0,0-.408-.247,4.274,4.274,0,0,1-1.233-1.233,1.084,1.084,0,0,0-.171-.437A.539.539,0,0,0,99.311,27.83ZM11.686,6.959A13.024,13.024,0,0,0,5.23,8.672,13.5,13.5,0,0,0,.346,13.319a11.873,11.873,0,0,0-1.838,6.4,12.762,12.762,0,0,0,.809,4.37,13.728,13.728,0,0,0,2.457,4.161,12.2,12.2,0,0,0,3.99,3.085,11.887,11.887,0,0,0,5.255,1.143,13.408,13.408,0,0,0,6.827-1.752,12.763,12.763,0,0,0,6.408-11.084,12.577,12.577,0,0,0-1.067-5.179,12.2,12.2,0,0,0-2.857-4.028,13.333,13.333,0,0,0-4.056-2.561A12.227,12.227,0,0,0,11.686,6.959ZM88.6,17.451a5.129,5.129,0,0,0-2.191.819A7.749,7.749,0,0,0,83.8,20.888a8.218,8.218,0,0,0-1.162,4.523,7.755,7.755,0,0,0,1.524,4.722A5,5,0,0,0,88.41,32.19a10.576,10.576,0,0,0,5.884-2.38l-.343-.457A8.475,8.475,0,0,1,91.8,30.514a5.811,5.811,0,0,1-1.828.324,4.36,4.36,0,0,1-3.542-1.923,5.812,5.812,0,0,1-1.019-1.99,14.749,14.749,0,0,1-.352-2.771L94.579,22.1l-.038-.7a.779.779,0,0,1-.876-.476,6.008,6.008,0,0,0-1.476-2.133,4.9,4.9,0,0,0-1.809-1.057A6.22,6.22,0,0,0,88.6,17.451ZM48.134,31.886c.867,0,2.559.09,5.027.266v-.724a11.418,11.418,0,0,1-1.733-.333c-.644-.171-1.028-.424-1.142-.751A45.527,45.527,0,0,1,50,23.056l.152-9.153a41.785,41.785,0,0,1,.742-8.144h-.573a29.734,29.734,0,0,1-5.14,2.58v.6c.079-.011.161-.023.249-.038l.249-.038a2.571,2.571,0,0,1,.365-.02,1.5,1.5,0,0,1,1.305.476c.343.468.517,2.4.517,5.728,0,1.572-.032,3.39-.1,5.4-.066,2.058-.134,3.8-.21,5.337s-.146,2.545-.21,2.977a3.168,3.168,0,0,1-.742,1.865,3.667,3.667,0,0,1-2.019.856v.59A34.03,34.03,0,0,1,48.134,31.886Zm11.35-14.854a13.212,13.212,0,0,1-4.437,2.495.373.373,0,0,0-.343.381c0,.1.286.183.876.247a2.551,2.551,0,0,1,.952.19,2,2,0,0,1,.333,1.048c.057.505.086,1.671.086,3.466,0,.134-.015.707-.048,1.857s-.074,2.063-.124,2.838a5.634,5.634,0,0,1-.171,1.362c-.139.277-.754.469-1.829.571l-.076.59,7.674-.19-.229-.553a11.755,11.755,0,0,0-1.333-.114,3.627,3.627,0,0,1-.914-.152.79.79,0,0,1-.381-.438,12.855,12.855,0,0,1-.239-2.408c-.045-1.207-.067-2.1-.067-2.733,0-.847.029-1.833.086-2.932s.13-2.163.219-3.162a16.612,16.612,0,0,1,.324-2.285,1.247,1.247,0,0,0-.362-.076ZM77.365,31.772A21.205,21.205,0,0,1,80.678,32l-.038-.59a9.577,9.577,0,0,0-.971-.248,2.791,2.791,0,0,1-.971-.324,8.125,8.125,0,0,1-.247-2.933V23.374a18.573,18.573,0,0,0-.2-3.037,3.489,3.489,0,0,0-1.045-1.962,3.809,3.809,0,0,0-2.69-.809,7.407,7.407,0,0,0-2.585.5,25.981,25.981,0,0,0-3.44,1.685,15.241,15.241,0,0,0-.077-1.828c-.051-.366-.173-.552-.364-.552a3.543,3.543,0,0,0-.86.382,13.982,13.982,0,0,1-1.443.68,15.253,15.253,0,0,1-2.189.814,1.324,1.324,0,0,1,.038.371,6.254,6.254,0,0,1,1.742.352,1.269,1.269,0,0,1,.609,1.008,19.9,19.9,0,0,1,.143,2.956c0,1.042-.019,2.079-.058,3.081a24.874,24.874,0,0,1-.209,2.566,1.976,1.976,0,0,1-.21.723,1.3,1.3,0,0,1-.628.475,7.417,7.417,0,0,1-1.5.4l.038.552H67.7c.831.027,1.487.058,2,.1.481.035.9.068,1.2.1l.038-.59a8.181,8.181,0,0,1-1.676-.314,1.248,1.248,0,0,1-.638-.41,1.592,1.592,0,0,1-.181-.686c-.075-.7-.1-2.137-.076-4.285l.114-5.065A11.29,11.29,0,0,1,71.4,19.451a10.361,10.361,0,0,1,1.842-.248,2.51,2.51,0,0,1,2.014.761,3.5,3.5,0,0,1,.788,1.838,21.868,21.868,0,0,1,.142,2.751c0,.74-.035,1.8-.1,3.152a8.952,8.952,0,0,1-.391,2.657,3.073,3.073,0,0,1-2.152,1.085V32A38.292,38.292,0,0,1,77.365,31.772Zm-37.039,0A21.205,21.205,0,0,1,43.639,32l-.038-.59a9.577,9.577,0,0,0-.971-.248,2.791,2.791,0,0,1-.971-.324,8.125,8.125,0,0,1-.247-2.933V23.374a18.573,18.573,0,0,0-.2-3.037,3.489,3.489,0,0,0-1.045-1.962,3.809,3.809,0,0,0-2.69-.809,7.407,7.407,0,0,0-2.585.5,25.981,25.981,0,0,0-3.44,1.685,15.091,15.091,0,0,0-.077-1.828c-.051-.366-.173-.552-.364-.552a3.543,3.543,0,0,0-.86.382,13.982,13.982,0,0,1-1.443.68,15.253,15.253,0,0,1-2.189.814,1.324,1.324,0,0,1,.038.371,6.254,6.254,0,0,1,1.742.352,1.269,1.269,0,0,1,.609,1.008,19.9,19.9,0,0,1,.143,2.956c0,1.042-.019,2.079-.058,3.081a24.873,24.873,0,0,1-.209,2.566,1.976,1.976,0,0,1-.21.723,1.3,1.3,0,0,1-.628.475,7.416,7.416,0,0,1-1.5.4l.038.552h4.181c.83.027,1.486.058,2.005.1.481.035.9.068,1.2.1l.038-.59a8.181,8.181,0,0,1-1.676-.314,1.241,1.241,0,0,1-.637-.41,1.567,1.567,0,0,1-.181-.686c-.076-.693-.1-2.134-.077-4.285l.114-5.065a11.3,11.3,0,0,1,2.906-1.123A10.361,10.361,0,0,1,36.2,19.2a2.51,2.51,0,0,1,2.014.761A3.5,3.5,0,0,1,39,21.8a21.87,21.87,0,0,1,.142,2.751c0,.74-.035,1.8-.1,3.152a8.953,8.953,0,0,1-.391,2.657A3.073,3.073,0,0,1,36.5,31.448V32A38.292,38.292,0,0,1,40.326,31.772ZM59.064,7.816a1.471,1.471,0,0,0-1.048.418A1.421,1.421,0,0,0,57.579,9.3a1.5,1.5,0,0,0,1.485,1.486,1.365,1.365,0,0,0,1.038-.438,1.532,1.532,0,0,0-.009-2.1A1.377,1.377,0,0,0,59.064,7.816ZM12.657,31.1a9.789,9.789,0,0,1-5.56-1.78,12.89,12.89,0,0,1-4.19-4.751,13.417,13.417,0,0,1-1.561-6.3,10.764,10.764,0,0,1,1.275-5.313A8.889,8.889,0,0,1,5.991,9.481a9,9,0,0,1,4.495-1.19,9.326,9.326,0,0,1,4.171.98,10.992,10.992,0,0,1,3.494,2.761,13.273,13.273,0,0,1,2.362,4.143,14.717,14.717,0,0,1,.848,4.989,11.126,11.126,0,0,1-1.276,5.541,8.352,8.352,0,0,1-3.266,3.324A8.669,8.669,0,0,1,12.657,31.1ZM85.1,23.412h0a11.02,11.02,0,0,1,.733-3.236,2.091,2.091,0,0,1,2.028-1.5,3.333,3.333,0,0,1,1.99.609,4.856,4.856,0,0,1,1.3,1.343,2.506,2.506,0,0,1,.457,1.038c0,.139-.09.242-.267.305s-.6.171-1.256.324c-.225.037-.664.131-1.343.285a9.044,9.044,0,0,0-1.152.3l-2.493.533Z" transform="translate(130 1)" fill="#D1D5DB"/><path id="Path_1" data-name="Path 1" d="M25.047,29.172q-.1.248-.819,2.818-2.057.609-3.732.943a18.658,18.658,0,0,1-3.637.333,14.043,14.043,0,0,1-4.723-.838,13.009,13.009,0,0,1-4.247-2.485A11.981,11.981,0,0,1,4.9,25.926a12.643,12.643,0,0,1-1.1-5.4,11.715,11.715,0,0,1,2.047-7.008A12.209,12.209,0,0,1,11.06,9.311,16.519,16.519,0,0,1,17.6,7.958a14.254,14.254,0,0,1,5.1.933,6.319,6.319,0,0,0,1.714.362q.267-.057.39-.076t.314-.038a.359.359,0,0,1,.248.152l-.286,1.085a28.1,28.1,0,0,0-.7,3.637.632.632,0,0,1-.457-.238,1.125,1.125,0,0,1-.114-.581,3.464,3.464,0,0,0-.324-1.638,5.647,5.647,0,0,0-2.571-1.714,10.467,10.467,0,0,0-4.132-.876,9.106,9.106,0,0,0-8.465,5.351,13.893,13.893,0,0,0-1.285,6.17A12.81,12.81,0,0,0,8.165,26.1,10.554,10.554,0,0,0,11,29.82a11.618,11.618,0,0,0,3.466,1.98,9.573,9.573,0,0,0,3.056.609,7.6,7.6,0,0,0,3.409-.676,6.369,6.369,0,0,0,2.123-1.619,14.957,14.957,0,0,0,1.495-2.257q.286-.552.5-.552.362,0,.362.343A9.449,9.449,0,0,1,25.047,29.172Zm6.132-7.408-2.342,1.047a4.157,4.157,0,0,1-.152-.9,2.276,2.276,0,0,1,1.19-1.8,10.845,10.845,0,0,1,2.685-1.343,7.755,7.755,0,0,1,2.085-.514,2.639,2.639,0,0,1,1.276.457,6.33,6.33,0,0,1,1.219.914,3.553,3.553,0,0,1,.619.752,4.136,4.136,0,0,1,.39,1.171,9.995,9.995,0,0,1,.171,2.038q0,.362-.1,2.552l-.076,1.428q-.076,1.028-.076,1.638a7.375,7.375,0,0,0,.209,1.676q.19.914.857.914a5.227,5.227,0,0,0,1.98-.552v.781l-2.8,1.124a6.392,6.392,0,0,1-.952.286,1.154,1.154,0,0,1-.866-.581,4.938,4.938,0,0,1-.7-1.381q-3.523,1.961-5.408,1.961a2.2,2.2,0,0,1-1.752-.676,3.01,3.01,0,0,1-.59-2.028,4.492,4.492,0,0,1,.314-1.923,2.234,2.234,0,0,1,1.019-.99,12.726,12.726,0,0,1,3.028-1.076q1.6-.352,3.352-.6l.1-2.342v-.628a3.5,3.5,0,0,0-.924-2.561,2.932,2.932,0,0,0-2.161-.943,2.435,2.435,0,0,0-1.19.333,1.034,1.034,0,0,0-.6.943A2.523,2.523,0,0,0,31.178,21.765Zm4.513,9.007q-.057-.628.114-3.58a7.66,7.66,0,0,0-4.023.609q-1.518.781-1.518,1.961a3.056,3.056,0,0,0,.465,1.619,1.434,1.434,0,0,0,1.281.762A11.258,11.258,0,0,0,35.692,30.772Zm5.979,2.266.038-.59a4.405,4.405,0,0,0,1.657-.665,2.768,2.768,0,0,0,.752-1.692,23.7,23.7,0,0,0,.238-3.935A17.875,17.875,0,0,0,44.1,22.5a1.958,1.958,0,0,0-.762-1.35,4.1,4.1,0,0,0-1.666-.3v-.638a14.627,14.627,0,0,0,4.17-1.761.738.738,0,0,1,.381-.153q.381,0,.467.99a9.327,9.327,0,0,1,.01,1.733q.4-.229,1.419-.771t1.6-.819a12.544,12.544,0,0,1,1.495-.571,5.31,5.31,0,0,1,1.6-.3,3.831,3.831,0,0,1,1.952.562,2.95,2.95,0,0,1,1.323,1.857,13.551,13.551,0,0,1,6.105-1.866,3.715,3.715,0,0,1,2.671.819,3.533,3.533,0,0,1,1.021,2.1,28.455,28.455,0,0,1,.181,3.7v3.39q-.057,1.466-.038,2.009a1.108,1.108,0,0,0,.181.7,1.049,1.049,0,0,0,.6.219q.152.019,1.057.209t1.038.209L68.635,33H61.4l-.115-.514a4.446,4.446,0,0,0,1.619-.667,2.513,2.513,0,0,0,.619-1.542,31.665,31.665,0,0,0,.181-4.132,12.816,12.816,0,0,0-.3-2.971A3.471,3.471,0,0,0,62.352,21.3a3.133,3.133,0,0,0-2.114-.657,9.727,9.727,0,0,0-3.98,1.047q.1.8.133,2.752t.076,4.018q.038,2.066.057,2.676a1.587,1.587,0,0,0,.171.714.825.825,0,0,0,.5.3q.371.1,1.59.267V33H56.41q-.324,0-2.4.076t-2.476.076l-.114-.59a4.651,4.651,0,0,0,1.809-.657,2.187,2.187,0,0,0,.733-1.447,21.6,21.6,0,0,0,.143-3.532l-.038-1.847a7.825,7.825,0,0,0-.714-3.571,2.337,2.337,0,0,0-2.219-1.228,5.043,5.043,0,0,0-1.562.267,11.327,11.327,0,0,0-1.562.638q-.743.371-1.276.657-.019.324-.038,1.647t-.038,2.18v1.942q.038,3.409.114,3.713a1.031,1.031,0,0,0,.552.619,6.835,6.835,0,0,0,2.057.5v.667q-.229,0-1.638-.076t-1.676-.076Zm27.65-11.921-.152-.543a12.153,12.153,0,0,1,1.278-.707,6.436,6.436,0,0,0,1.67-.8,6.939,6.939,0,0,0,1.937-1.471,21.117,21.117,0,0,1,.409,2.685l1.638-.647a11.209,11.209,0,0,1,3.866-1.066,5.145,5.145,0,0,1,2.847.933,7.1,7.1,0,0,1,2.3,2.514A6.825,6.825,0,0,1,86,25.4a6.649,6.649,0,0,1-1.047,3.837,7.321,7.321,0,0,1-2.58,2.361,11.743,11.743,0,0,1-2.952,1.152,10.57,10.57,0,0,1-2.142.324,9.056,9.056,0,0,1-2.818-.552q0,.342-.038,2.148t-.038,2.11v3.459a10.784,10.784,0,0,0,.1,1.73.889.889,0,0,0,.352.656,2.249,2.249,0,0,0,.885.18l1.39.076q.476,0,.476.372,0,.235-.143.293a2.313,2.313,0,0,1-.676.059q-2.361,0-2.952.029t-3.885.238a3.566,3.566,0,0,0-.038-.571,3.281,3.281,0,0,0,1.295-.276,1.347,1.347,0,0,0,.514-.657,13.279,13.279,0,0,0,.4-3.359q.1-2.522.1-5.263l.038-2.379q0-2.741-.038-5.663a33.165,33.165,0,0,0-.152-3.569,2.907,2.907,0,0,0-.3-.733,1.936,1.936,0,0,0-.476-.571.9.9,0,0,0-.562-.219A6.649,6.649,0,0,0,69.322,21.117Zm5.1-.057L74.387,30.7l1.752.59a10.661,10.661,0,0,0,2.78.667,5.553,5.553,0,0,0,2.076-.467A4.914,4.914,0,0,0,83,29.915a4.523,4.523,0,0,0,.866-2.875,7.666,7.666,0,0,0-3.123-6.17,4.466,4.466,0,0,0-2.533-.933A19.807,19.807,0,0,0,74.425,21.06Zm13.368.419v-.79l4.244-2.351.382-.153q.267,0,.267.343L92.449,21.8q-.238,3.885-.238,4.8a9.648,9.648,0,0,0,.57,3.571q.57,1.419,2.659,1.419a4.679,4.679,0,0,0,1.377-.219,12.462,12.462,0,0,0,1.653-.667q.94-.448,1.472-.714A18.411,18.411,0,0,1,100,28.132l.114-3.888A10.873,10.873,0,0,0,100,21.75a1.237,1.237,0,0,0-.657-.939,4.853,4.853,0,0,0-1.609-.247l-.038-.733,5.084-1.19q-.1,1.714-.2,3.266t-.19,3.323Q102.3,27,102.3,27.858a14.182,14.182,0,0,0,.362,3.885,7.01,7.01,0,0,0,2.133-.457v.857q-2.159.59-4.376,1.409a15.7,15.7,0,0,1-.518-2.7q-4.657,2.38-6.462,2.38a3.572,3.572,0,0,1-2.433-1.16q-1.217-1.16-1.1-4.487l.152-4.278a7.891,7.891,0,0,0-.086-1.74.678.678,0,0,0-.733-.6A4.742,4.742,0,0,0,87.793,21.479Zm18.529,7.236.667.038a2.514,2.514,0,0,0,.619,1.181,6.15,6.15,0,0,0,1.666,1.476,4.218,4.218,0,0,0,2.285.657,4.54,4.54,0,0,0,1.79-.381,1.6,1.6,0,0,0,.9-1.657,2.742,2.742,0,0,0-.92-2.152,10.341,10.341,0,0,0-2.118-1.39l-1.431-.667a8.321,8.321,0,0,1-2-1.371,2.4,2.4,0,0,1-.744-1.828,3.375,3.375,0,0,1,.63-1.838,4.779,4.779,0,0,1,1.823-1.59,5.706,5.706,0,0,1,2.7-.628,26.461,26.461,0,0,1,3.054.286l.628,3.237H115.2a2.727,2.727,0,0,0-.793-1.266,5.882,5.882,0,0,0-1.452-1.019,3.289,3.289,0,0,0-1.423-.419,2.223,2.223,0,0,0-1.643.63,2.171,2.171,0,0,0-.631,1.6,1.673,1.673,0,0,0,.46,1.241,6.574,6.574,0,0,0,1.739,1.1l1.164.55a11.332,11.332,0,0,1,2.71,1.729,3.543,3.543,0,0,1,1.126,2.78,4.114,4.114,0,0,1-.277,1.418,1.974,1.974,0,0,1-.83,1.076,10.736,10.736,0,0,1-2.614,1.3,7.584,7.584,0,0,1-2.1.3,8.758,8.758,0,0,1-1.088-.1q-.706-.1-.992-.152t-.992-.267q-.706-.209-.916-.267a6.4,6.4,0,0,0,.152-1.085,7.238,7.238,0,0,0-.162-1.3A8.077,8.077,0,0,0,106.322,28.715Z" fill="#D1D5DB"/></g></svg>
      </div>
    :
    children}
		</AuthContext.Provider>
		)
	}